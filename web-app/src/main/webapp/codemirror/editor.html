<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Tamil editor</title>
    <script src="lib/codemirror.js"></script>
    <script src="addon/selection/active-line.js"></script>
    <script src="addon/hint/show-hint.js"></script>
    <script type="text/javascript" src="../jquery-1.9.1.js" charset="utf-8"></script>
    <script type="text/javascript" src="../service-consumer.js" charset="utf-8"></script>

    <link rel="stylesheet" href="lib/codemirror.css">
    <link rel="stylesheet" href="addon/hint/show-hint.css">
    <link rel="stylesheet" type="text/css" href="../punarchi.css"/>


    <script>

        //Starts with pulli and then aa
        var glyph = ['\u0BCD', '\u0BBE', '\u0BBF', '\u0BC0', '\u0BC1', '\u0BC2', '\u0BC6', '\u0BC7', '\u0BC8', '\u0BCA', '\u0BCB', '\u0BCC'];
        var TRANSLIT = true;
        function containsInArray(a, obj) {
            for (var i = 0; i < a.length; i++) {

                if (a[i] === obj) {

                    return true;
                }
            }
            return false;
        }

        function get_glyph_count(text, max) {
            if (!text || max <= 0) return 0;
            var c = 0;
            for (var i = 0; i < max; i++) {
                if (containsInArray(glyph, text.charAt(i))) {
                    c++;
                }
            }
            return c;
        }

        function get_last_word(text, max) {
            if (!text || max <= 0) return "";
            var word = "";
            for (var i = max - 1; i >= 0; i--) {
                var space = text.charAt(i);
                if (space == ' ') {
                    return word;
                }
                word = space + word;
            }
            return word;
        }


        function get_current_word(cm) {
            var pos = cm.getCursor();
            var currentToken = cm.getTokenAt(pos, true);
            if (!currentToken || !currentToken.string) {
                return "";
            }
            return get_last_word(currentToken.string, pos.ch);
        }


        function handleCursorForTamilGlyphs(cm, left) {
            var pos = cm.getCursor();
            if (tool_tip.parentNode) {

                tool_tip.parentNode.removeChild(tool_tip);
            }

            var currentToken = cm.getTokenAt(pos, true);
            if (!currentToken || !currentToken.string) {
                return;
            }


            if (currentToken.string.length > pos.ch) {
                var currentChar = currentToken.string.charAt(pos.ch);
                //  console.log(currentChar);

                if (containsInArray(glyph, currentChar)) {
                    if (left && pos.ch > 0) {

                        pos.ch--;
                    } else {
                        pos.ch++;
                    }

                    cm.setCursor(pos);
                    return;
                }
            }


            var current_word = get_current_word(cm);
            var current_tamil_word = null;
            if (TRANSLIT) {
                current_tamil_word = getTamilWord(current_word, false, false, true).tamilWord;
                cm.addWidget({
                    line: pos.line,
                    ch: (current_word ? pos.ch - current_word.length : pos.ch)
                }, tool_tip, true);
            } else {
                current_tamil_word = "(" + (pos.line + 1) + "," + (pos.ch + 1 - get_glyph_count(currentToken.string, pos.ch)) + ")";
                cm.addWidget(pos, tool_tip, true);
            }
            if ($('.CodeMirror-hints') && $('.CodeMirror-hints').is(":visible")) {
                $('#tool_tip').hide();
            } else {

                $('#tool_tip').show();
                $('#tool_tip').html(current_tamil_word);
            }
            // console.log("showing ...")  ;


        }

        function _unload() {
            localStorage.setItem("english-text___", myCodeMirror.getValue());
        }


        var myCodeMirror = null;
        var tool_tip = null;
        function _load() {
            var old = localStorage.getItem("english-text___");
            if (old) {
                $("#edit").val(old);
            } else {
                $("#edit").val("");
            }

            server = "../" + server;
            myCodeMirror = CodeMirror.fromTextArea(document.getElementById("edit"), {
                        styleActiveLine: true,
                        extraKeys: {"Ctrl-Space": _autocomplete},
                        lineNumbers: true,
                        searchMode: 'inline',
                        lineWrapping: true
//                        lineNumberFormatter : function(line) {
//                           // var cm = $('.CodeMirror')[0].CodeMirror;
//                            //var cur = cm.getCursor();
//                            return line + ":" + cur.ch;
//                        }
                    }
            );

            myCodeMirror.on("change", _onChange);
            myCodeMirror.on("keyHandled", _onKeyHandled);
            myCodeMirror.on("cursorActivity", _cursorActivity);
            myCodeMirror.on("beforeChange", _beforeChange);
            myCodeMirror.on("keydown", _keydown);
            myCodeMirror.on("contextmenu", _contextmenu);
            myCodeMirror.on("dblclick", _contextmenu);

            $('<div/>', {
                id: 'tool_tip',
                class: 'temp_tamil_tip'

            }).appendTo('body');

            tool_tip = document.getElementById('tool_tip');

            setTimeout(_backgroundSpellCheck, 500);
        }


        function _processWordForSpellCheck(lineno, startCol, fullword) {


             getTamilWordAsync(function (current_tamil_obj) {
                 if (!current_tamil_obj.known) {
                     myCodeMirror.markText({
                                 line: lineno,
                                 ch: startCol
                             }, {
                                 line: lineno,
                                 ch: startCol + fullword.length
                             }, {
                                 inclusiveLeft: true,
                                 inclusiveRight: false,
                                 className: "note"
                             }
                     )
                 }
             }, fullword, true, false, true);


        }


        function _processLineForSpellCheck(lineno, fullLine) {
            if (fullLine) {

                var token = "";
                for (var i = 0; i < fullLine.length; i++) {
                    var ch = fullLine.charAt(i);
                    if (ch == ' ') {
                        if (token.trim()) {
                            _processWordForSpellCheck(lineno, i - token.trim().length, token.trim());

                        }

                        token = "";
                    } else {
                        token += ch;
                    }
                }
                if (token.trim()) {
                    _processWordForSpellCheck(lineno, fullLine.length - token.trim().length, token.trim());
                }


            }
        }

        function _backgroundSpellCheck() {
            var markers_old = [];
            var marks = myCodeMirror.getAllMarks();
            if (marks) {
                for (var i = 0; i < marks.length; i++) {
                    markers_old.push(marks[i]);
                }
            }

            myCodeMirror.eachLine(function (lineHandle) {
                var text = lineHandle.text;
                var lineno = lineHandle.lineNo();
                _processLineForSpellCheck(lineno, text);

            });


            for (var i = 0; i < markers_old.length; i++) {
                markers_old[i].clear();
            }

//            if (myCodeMirror.getAllMarks().length > 0) {
//                //setTimeout(_backgroundSpellCheck, 5000);
//            }    else {
//              //  setTimeout(_backgroundSpellCheck, 10000);
//            }
            console.log(myCodeMirror.getAllMarks().length);
        }

        function _beforeChange(cm, change) {
            if (!TRANSLIT) return;
            var space = change.text.length == 1 && change.text[0] == " ";
            var newline = change.text.length == 2 && change.text[0] == "" && change.text[1] == "";
            if (space || newline) {
                var pos = cm.getCursor();
                var current_word = get_current_word(cm);
                if (current_word) {
                    var current_tamil_word = getTamilWord(current_word, false, false, true).tamilWord;
                    if (current_word != current_tamil_word) {
                        change.cancel();
                        // console.log("replaced ....");
                        cm.replaceRange(current_tamil_word + (space ? " " : "\n"), {
                                    line: pos.line,
                                    ch: pos.ch - current_word.length
                                }, pos, "tamil"
                        );
                    }
                }
            }
        }

        function _cursorActivity(cm) {

            //console.log(cm.getCursor());
            handleCursorForTamilGlyphs(cm, false);
        }

        function _keydown(cm, event) {
            if (event.ctrlKey && event.which == 84) {
                TRANSLIT = !TRANSLIT;

                handleCursorForTamilGlyphs(cm, false);

                event.preventDefault();
                return;
            }
        }

        function _contextmenu(cm, event) {
            _autocomplete(cm);
        }


        function _onKeyHandled(cm, name, event) {
            //  console.log(event);

            //ctrl + space is handled.
            if (event.ctrlKey && event.which == 32) {
                return;
            }

            handleCursorForTamilGlyphs(cm, event.keyCode == 37 || event.keyCode == 8);
            var pos = cm.getCursor();

            if (event.keyCode == 13) {
                var currentToken = cm.getTokenAt(pos, true);
                if (!currentToken) {
                    return;
                }
            }
        }

        function _provideHint(cm, callback, options) {

            // console.log(callback);

            var current_word = get_current_word(cm);
            // if (current_word) {
            var suggestedwords = _getSuggestionFor(current_word, true);
            var data = [];
            if (suggestedwords != null) {
                for (var sug = 0; sug < suggestedwords.length; sug++) {
                    if (sug == 1 && current_word) {
                        var trans = getTamilWord(current_word, false, false, true).tamilWord;
                        if (trans != suggestedwords[0]) {
                            data.push({
                                text: trans,
                                displayText: ">> " + trans
                            });
                        }
                    }
                    data.push({
                        text: suggestedwords[sug],
                        displayText: suggestedwords[sug]
                    });
                }
            }
            var pos = cm.getCursor();
            var from_word = {line: pos.line, ch: pos.ch - current_word.length};


            callback({
                list: data, from: from_word, to: cm.getCursor()
            });


            //   }

        }

        _provideHint.async = true;

        function _autocomplete(cm) {
            cm.showHint({
                hint: _provideHint

            });


        }


        var SPELL_CHECK = null;
        function _onChange(cm, changed) {
            // no change
            if (SPELL_CHECK) {
                clearTimeout(SPELL_CHECK);
            }
            SPELL_CHECK = setTimeout(_backgroundSpellCheck, 500);

        }
    </script>

</head>
<body onload="javascript:_load()" onunload="javascript:_unload()">
<a href="../index.html">&lt;-பின்னுக்குச்செல்க</a>
<!--<div id="tool_tip" class="temp_tamil_tip"></div>-->
<p>Press CTRL+t to toggle transliteration.</p>

<p>Press CTRL+space to look for suggestions.</p>
<textarea rows="10" cols="80" id="edit">


</textarea>
<a href="../index.html">&lt;-பின்னுக்குச்செல்க</a>
</body>
</html>